Import('env', 'envCython', 'cereal', 'cython_dependencies')

import os
from opendbc.can.process_dbc import process

dbcs = []
for x in sorted(os.listdir('../')):
  if x.endswith(".dbc"):
    def compile_dbc(target, source, env):
      process(source[0].path, target[0].path)
    in_fn = [os.path.join('../', x), 'dbc_template.cc']
    out_fn = os.path.join('dbc_out', x.replace(".dbc", ".cc"))
    dbc = env.Command(out_fn, in_fn, compile_dbc)
    dbcs.append(dbc)


libdbc = env.SharedLibrary('libdbc', ["dbc.cc", "parser.cc", "packer.cc", "common.cc"]+dbcs, LIBS=["capnp", "kj"])

# envCython.Program('parser_pyx.so', 'parser_pyx.pyx', LIBS=envCython["LIBS"]+["libdbc"])
# envCython.Program('packer_pyx.so', 'packer_pyx.pyx', LIBS=envCython["LIBS"]+["libdbc"])

# Build packer and parser
env.Command(['packer_pyx.so', 'packer_pyx.cpp', 'parser_pyx.so', 'parser_pyx.cpp'],
            cython_dependencies + [libdbc, cereal, 'common_pyx_setup.py', 'common.pxd', 'packer_pyx.pyx', 'parser_pyx.pyx', 'packer.cc', 'parser.cc'],
            "cd opendbc/can && python3 common_pyx_setup.py build_ext --inplace")

# building 'parser_pyx' extension
# gcc -pthread -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/batman/openpilot/opendbc/can -I/home/batman/openpilot -I/home/batman/openpilot/phonelibs -I/home/batman/.pyenv/versions/3.8.2/include/python3.8 -c parser_pyx.cpp -o build/temp.linux-x86_64-3.8/parser_pyx.o -std=c++1z -Wno-nullability-completeness
# g++ -pthread -shared -L/home/batman/.pyenv/versions/3.8.2/lib -Wl,-rpath=/home/batman/.pyenv/versions/3.8.2/lib -L/home/batman/.pyenv/versions/3.8.2/lib -Wl,-rpath=/home/batman/.pyenv/versions/3.8.2/lib build/temp.linux-x86_64-3.8/parser_pyx.o -L/home/batman/.pyenv/versions/3.8.2/lib -o /home/batman/openpilot/opendbc/can/parser_pyx.so /home/batman/openpilot/opendbc/can/libdbc.so

# building 'packer_pyx' extension
# gcc -pthread -Wno-unused-result -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/home/batman/openpilot/opendbc/can -I/home/batman/openpilot -I/home/batman/openpilot/phonelibs -I/home/batman/.pyenv/versions/3.8.2/include/python3.8 -c packer_pyx.cpp -o build/temp.linux-x86_64-3.8/packer_pyx.o -std=c++1z -Wno-nullability-completeness
# g++ -pthread -shared -L/home/batman/.pyenv/versions/3.8.2/lib -Wl,-rpath=/home/batman/.pyenv/versions/3.8.2/lib -L/home/batman/.pyenv/versions/3.8.2/lib -Wl,-rpath=/home/batman/.pyenv/versions/3.8.2/lib build/temp.linux-x86_64-3.8/packer_pyx.o -L/home/batman/.pyenv/versions/3.8.2/lib -o /home/batman/openpilot/opendbc/can/packer_pyx.so /home/batman/openpilot/opendbc/can/libdbc.so
